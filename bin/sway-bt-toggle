#!/usr/bin/env python
import json
import shlex
import subprocess


def main():
    rfkill_status = None
    try:
        stdout = run_cmd("rfkill -J -o type,soft")
        rfkill_status = parse_rfkill_output(stdout)

    except Exception as err:
        exit(err)

    toggle_bt(rfkill_status)


class CmdEdnsWithError(subprocess.SubprocessError):
    pass


def run_cmd(cmd):
    r = subprocess.run(shlex.split(cmd), capture_output=True, text=True)
    if r.returncode:
        raise CmdEdnsWithError(
            f'{r.args} ended with exit code "{r.returncode}": stderr - {r.stderr}; stdout - {r.stdout}'
        )

    return r.stdout


def parse_rfkill_output(data):
    d = json.loads(data)

    status = None
    for items in d.values():
        for item in items:
            if item["type"] != "bluetooth":
                continue

            status = item["soft"]

    return status


def toggle_bt(rfkill):
    if rfkill == "unblocked":
        run_cmd("sudo /usr/bin/systemctl start bluetooth.service")

    if rfkill == "blocked":
        run_cmd("sudo /usr/bin/systemctl stop bluetooth.service")


if __name__ == "__main__":
    main()
